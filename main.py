# 主文件
import argparse
# import sys, getopt
import re
from get import poc
from post import exp

def hello():
    print("--------------------------")
    print("CVE-2021-41773")
    print("--------------------------")

# url处理
def urlHandler(url):
    if url.endswith('/') == True:
        url = re.sub('/\\n','',url)
    else :
        url = re.sub('\\n','',url)
    if url.startswith('http://')== True:
        url = url
    elif url.startswith('https://')==True:
        url = re.sub('https://', 'http://', url)
    else:
        url = "http://" + url
    return url


# 命令行解析参数
# 1. 定义命令行解析器对象
parser = argparse.ArgumentParser(description='Demo of argparse')
 
# 2. 添加命令行参数
parser.add_argument("-u","--url",help="url Address") # 添加可解析的参数
parser.add_argument("-f","--file",help="read file <.txt>")  # 添加可解析的参数
parser.add_argument("-o","--outfile",help="out file <.txt>")  # 添加可解析的参数

args = parser.parse_args()

# -u 模式
if args.url:
    url = args.url
    hello()
    url = urlHandler(url)
    print(url)
    if poc(url):
        print(url, "存在漏洞")
        exp(url)
    else:
        print(url, "不存在漏洞")

# -f 模式
elif args.file:
    target = args.file
    hello()
    # print(target)
    with open(target,"r") as fp:
        s1 = fp.read()
    lis = list(s1.split("\n"))
    for url1 in lis:
        url = urlHandler(url1)
        # print(url)
        try:
            if poc(url):
                print(url)

                # -o 模式
                if args.outfile:
                    outfile = args.outfile
                    with open(outfile, "w") as fp:
                        fp.write(url)
        except:
            continue
