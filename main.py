# 主文件
import sys, getopt
import re
import requests
from get import poc
from post import exp

def hello():
    print("CVE-2021-41773")
# url处理
def urlHandler(url):
    if url.endswith('/') == True:
        url = re.sub('/\\n','',url)
    else :
        url = re.sub('\\n','',url)
    if url.startswith('http://')== True:
        url = url
    elif url.startswith('https://')==True:
        url = re.sub('https://', 'http://', url)
    else:
        url = "http://" + url
    return url


# 读写文件
# def file(target, bug):
#     # -f 模式
#     with open(target,"r") as fp:
#         s1 = fp.read()
#     lis = list(s1.split("\n"))
#     for url in lis:
#         try:
#             if poc(url):
#                 # -o 模式
#                 with open(bug, "w") as fp:
#                     fp.write(url)
#         except:
#             continue
# 命令行解析参数
def main(argv):
    try:
        #opts, args = getopt.getopt(argv,"hi:o:",["ifile=","ofile="])
        opts, args = getopt.getopt(argv,"hu:o:f:",["url=","ofile=","file="])
    except getopt.GetoptError:
        hello()
        print ('main.py -h  =》 帮助')
        print ('main.py -u <url>')
        print ('main.py -f  =》 批量验证url')
        print ('main.py -o   =》输出到文件，和-f一起用')
        sys.exit(2)
    for opt, arg in opts:
        if opt == '-h':
            hello()
            print ('main.py -h  =》 帮助')
            print ('main.py -u <url>')
            print ('main.py -f  =》 批量验证url')
            print ('main.py -o   =》输出到文件，和-f一起用')
            sys.exit()
        elif opt in ("-u", "--url"):
            url = arg
        elif opt in ("-f", "--file"):
            target = arg
        elif opt in ("-o", "-ofile"):
            bug = arg
        # print(url)
        # poc(url)
        # -u 模式
        hello()
        url = urlHandler(url)
        print(url)
        if poc(url):
            print(url, "存在漏洞")
            exp(url)
        else:
            print(url, "不存在漏洞")

        # -f 模式
        with open(target,"r") as fp:
            s1 = fp.read()
        lis = list(s1.split("\n"))
        for url in lis:
            try:
                if poc(url):
                    # -o 模式
                    with open(bug, "w") as fp:
                        fp.write(url)
            except:
                continue


if __name__ == "__main__":
    main(sys.argv[1:])